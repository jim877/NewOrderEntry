// @ts-nocheck
import React, { useState, useEffect, useRef, useMemo, useCallback, memo } from 'react';

// --- STYLES ---
const STYLES = `
  /* Input Reset */
  input[type=number]::-webkit-inner-spin-button, 
  input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number] { -moz-appearance: textfield; }
  
  /* Animations */
  .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  .slide-up { animation: slideUp 0.3s ease-out forwards; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  .scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  @keyframes scaleIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

  /* --- PURPLE SECTION FADE (3 seconds) --- */
  .animate-purple-section-fade {
      border-width: 2px;
      border-style: solid;
      animation: purpleSectionFade 3s ease-out forwards;
  }
  @keyframes purpleSectionFade {
    0% { border-color: #9333ea; box-shadow: 0 0 15px rgba(147, 51, 234, 0.2); background-color: rgba(147, 51, 234, 0.03); }
    30% { border-color: #9333ea; box-shadow: 0 0 10px rgba(147, 51, 234, 0.1); }
    100% { border-color: #e2e8f0; box-shadow: none; background-color: transparent; }
  }

  /* --- BUTTON SELECTION FADE (Ripple Ring) --- */
  .animate-outline-fade-purple {
      animation: outlineFadePurple 0.6s ease-out forwards;
  }
  @keyframes outlineFadePurple {
      0% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.6); }
      100% { box-shadow: 0 0 0 8px rgba(124, 58, 237, 0); }
  }
  
  /* --- ORANGE HIGHLIGHT (Smart Fields) --- */
  .animate-orange-highlight {
      animation: orangeHighlight 2s ease-out forwards;
  }
  @keyframes orangeHighlight {
      0% { border-color: #f97316; background-color: #fff7ed; box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.2); }
      100% { border-color: #e2e8f0; background-color: white; box-shadow: none; }
  }

  /* Custom Scrollbar */
  .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
  .custom-scroll::-webkit-scrollbar-track { background: transparent; }
  .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

  .audit-missing { border-color: #ef4444 !important; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15); }
  .audit-pill { background: #fff5f5; color: #b91c1c; border: 1px solid #fecaca; }

  .compact-mode input,
  .compact-mode select,
  .compact-mode textarea {
    padding-top: 0.25rem;
    padding-bottom: 0.25rem;
    font-size: 0.8125rem;
  }
  .compact-mode .section-header-tight { padding-top: 0.5rem; padding-bottom: 0.5rem; }
  .compact-mode .p-6 { padding: 0.9rem !important; }
  .compact-mode .p-5 { padding: 0.8rem !important; }
  .compact-mode .p-4 { padding: 0.7rem !important; }
  .compact-mode .gap-6 { gap: 0.75rem !important; }
  .compact-mode .gap-4 { gap: 0.5rem !important; }
  .compact-mode .gap-3 { gap: 0.4rem !important; }
  .compact-mode .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.75rem !important; }
  .compact-mode .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem !important; }
  .compact-mode .space-y-3 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.4rem !important; }

  html { scroll-behavior: smooth; }
`;

// --- UTILS ---
function safeUid(){ 
  try {
    if(typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
  } catch(e) {}
  return "id-" + Date.now().toString(36) + Math.random().toString(36).slice(2);
}

const formatPhoneNumber = (value) => {
  if (!value) return value;
  const phoneNumber = value.replace(/[^\d]/g, '');
  const phoneNumberLength = phoneNumber.length;
  if (phoneNumberLength < 4) return phoneNumber;
  if (phoneNumberLength < 7) {
    return `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3)}`;
  }
  return `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3, 6)}-${phoneNumber.slice(6, 10)}`;
};

const isValidEmail = (email) => {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
};

const normalizeContact = (value) => value.trim().toLowerCase();

// --- CONSTANTS ---
const STATES=["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
const CUSTOMER_TYPES=["Assistant", "Attorney", "Daughter", "Employee", "Father", "Housekeeper", "Husband", "Manager", "Mother", "Neighbor", "Owner", "Partner", "Policyholder", "Son", "Wife"];
const DEFAULT_COMPANIES=["Allstate", "State Farm", "Company 1", "Company 2"];
const DEFAULT_CONTACTS=["Contact 1", "Contact 2"];
const WELCOME_CAMPAIGNS=["Brochure", "Rush Guide", "Vcard"];
const VENDOR_TYPES=["Art","Contents","Moving","Mitigation","Contractor","Consultant","Agent","Broker","Decorator","Building Management","Superintendent","Other"];
const SALES_REPS=["Jim Fenyo","Dave Fenyo, Sales Rep","Josh Cintron, Sales Rep"];
const SERVICE_OFFERINGS=["Art","Appliance","Textiles"];

// --- CONSTANTS FOR SELECTIONS ---
const LOSS_TYPES = ["Fire", "Water", "Mold", "Dust/Debris", "Puffback", "Non-Restoration Cleaning", "Oil"];

const CAUSES = {
  "Fire": ["Battery", "Candle", "Cooking", "Electrical", "Explosion", "Fireplace", "Flammables", "Heating", "Neighbor", "Protein", "Smoking", "Wildfire"],
  "Water": ["Roof Leak", "Window/Door Leak", "Frozen Pipes", "Pipe Burst", "Overflow", "Storm"],
  "Mold": ["Spores Only", "Visible Mold", "Moldy Odor"],
  "Dust/Debris": ["Mitigation", "Construction", "Fiberglass"],
  "Puffback": ["Oily Odor"],
  "Non-Restoration Cleaning": ["Inhome Cleaning", "Pickup", "Stain Removal"],
  "Oil": ["Spill", "Furnace"]
};

const ORIGINS = ["Basement", "Bathroom", "Attic", "Family", "Garage", "Kitchen", "Laundry", "Living", "Master", "Outside", "Roof", "Walls"];

const PHONE_TYPES = ["Mobile", "Home", "Office"];
const ESTIMATE_TYPES = ["Ballpark", "Tag and Hold", "Itemized (costs)", "TLI", "Cash-out"];
const TECHS = ["Mike S.", "Sarah J.", "Tom B.", "Unassigned"];
const LEAD_SOURCES = ["Referral", "Marketing", "Internal"];
const CONTACT_METHODS = ["Call", "Email", "Form Submission", "Meeting", "Text", "TPA Assignment"];
const REFERRAL_SOURCES = ["Referring Co", "Referrer"];
const MARKETING_SOURCES = ["Website", "Google Business Page", "AI Recommendation", "Social Media", "Other"];
const INTERNAL_TYPES = ["Chase", "Previous Customer", "Friend of Company"];

const COMPANY_TYPES = [
  "Insurance",
  "Public Adjusting",
  "Independent Adjusting",
  "TPA",
  "Invoice Auditor",
  "Contents Company",
  "Restoration Company",
  "Art",
  "Moving",
  "Boardup",
];

const TIME_SLOTS = [];
for(let i=8; i<=18; i++) {
    const hour = i > 12 ? i - 12 : i;
    const ampm = i >= 12 ? 'PM' : 'AM';
    TIME_SLOTS.push(`${hour}:00 ${ampm}`);
    TIME_SLOTS.push(`${hour}:30 ${ampm}`);
}

const QUALITY_CODES = ["Q1", "Q2", "Q3", "Q5"];
const SEVERITY_GROUPS = ["Fire", "Water", "Mold", "Dust", "Protein", "Oil"];
const SEVERITY_LEVELS = ["1", "2", "3", "5"];

const HANDLING_META=[
  ["Box","return items in boxes"], ["Damp","tag within 5 days"], ["DC","try to Dry Clean all items"],
  ["DNR","do not reject"], ["Det","special detergent requested"], ["FMP","fold as much as possible"],
  ["Hand","hand finish pressed items"], ["Hang","use customers hangers"], ["Low","dry on low heat"],
  ["NoDC","Do not Dry Clean"], ["NoDry","cannot be dried in dryer"], ["PPC","Potential Problem Claim"],
  ["PPE","wear PPE when handling"], ["STAR","premium items, special hangers"], ["VIC","Very Important Claim"],
  ["Wet","still wet, tag/treat asap"],
];

function initAddress(overrides={}){
  return { id:safeUid(), type:"", isPrimary:true, isLossSite:true,
    name:"", googleQuery:"", street:"", apt:"", city:"", state:"", zip:"", lng:"", lat:"",
    beds:"", baths:"", sqft:"", people:"", infants:"", otherUnitsAffected:"", otherUnitsNote:"",
    coiRequired:"", coiRequestedAt:"", coiRequestedBy:"", coiProvidedAt:"", coiProvidedBy:"", coiContactNote:"", ...overrides };
}

function initCustomer(overrides={}){ 
  return { 
    id:safeUid(), type:"Policyholder", selfPay:false, policyHolder:true, 
    last:"", first:"", 
    phone:"", phoneType:"Mobile", phoneExt:"", 
    phone2:"", phone2Type:"Mobile", phone2Ext:"", 
    email:"", email2:"", 
    preferredContact: "", 
    note:"", isPrimary:false,
    showExtraContact: false,
    sendWelcomeText: false, welcomeCampaigns: [],
    ...overrides 
  }; 
}

const DEFAULT_FORM={
  isLead: true,
  isRestorationProject: "",
  insuranceStatus: "",
  leadSourceCategory: "", 
  leadSourceDetail: "",
  contactMethod: "", 
  
  orderNumber:"150001", orderName:"", orderNameLocked:false,
  referringCompany:"Servpro of Anytown", referrer:"",
  
  orderTypes: [],
  lossDetails: {}, 
  
  livingStatus: "", 
  processType: "",
  repairsSummary: "",
  
  noHeat: false,
  noLights: false,
  boardedUp: false,
  damageWasWet: false, 
  damageMoldMildew: false,

  addresses:[initAddress()], customers:[initCustomer({isPrimary:true})], peopleQuick:[], addCRMlog:false,
  billingPayer:"", billingMethod:"", billingNote:"", directionOfPayment: "",
  billingCompany: "", billingContact: "",
  estimateNeeded:"", estimateRecipients:[], estimateType:"",
  pickupBeforeApproval:"", pickupBeforeApprovalNote:"", scopeApproved:"", estimateAmount:"", estimateApprovedAt:"",
  insuranceClaim:"", insuranceCompany:"", insuranceAdjuster:"", claimNumber:"", dateOfLoss:"", rentOrOwn:"",
  contentsCoverageLimit:"", moldLimit:"", publicAdjustingCompany:"", publicAdjuster:"", independentAdjustingCo:"",
  independentAdjuster:"", tpaCompany:"", tpaContact:"", 
  salesRep: "",
  serviceOfferings: [],
  vendors:[],
  vendorDetails:{},
  showReferralVendor: true,

  additionalCompanyTypes: [],
  additionalCompanies: {},
  
  handlingCodes:[], 
  qualityCode:"", 
  severityCodes: [],
  preferenceNote:"",
  
  structuralElectricDamage:"", willPaint:"", willSandWoodFloors:"", willRemoveWindowTreatments:"", willPackOutFurniture:"",
  everyoneOk:"", everyoneOkNote:"", familyMedicalIssues:"", familyMedicalNote:"", soapFragAllergies:"", soapFragNote:"",
  useDryCleaner:"", useDryCleanerNote:"", selfCleaning:"", selfCleaningNote:"", donateSalvation:"", donateSalvationNote:"",
  howDryLaundry:"", howDryNote:"",
  
  scheduleType: "Scope", 
  eventInstructions: "",
  quickInstructionNotes: [],
  estimateRequested: false, 
  estimateRequestedType: "",
  meetingWith: [],
  pickupDate: new Date().toISOString().split('T')[0],
  pickupTime: "09:00 AM",
  assignedTech: "",

  quickScopeNotes: [], 
  loadList: [], 

  postPickup:{
    totalLoss:{taken:false,left:false,listed:false}, notWorthCleaning:{taken:false,left:false,listed:false},
    donationItems:{taken:false,left:false,listed:false}, cashOut:{taken:false,left:false,listed:false},
    testCleaning:{taken:false,left:false,listed:false},
  },
  additionalObservations:[], whoAtPickup:[], storageNeeded:"", storageMonths:"", highlightMissing:{},
};

// --- UI PRIMITIVES ---
const Chevron = ({open}) => <span className={`text-slate-400 transition-transform duration-200 ${open?"rotate-90":""}`}>‚Ä∫</span>;

const Field = ({label,children,subtle,missing, className, action, smart, id}) => (
  <div id={id} className={`flex flex-col gap-1.5 ${className||""}`}>
    <div className="flex items-center justify-between">
        <label className={`flex items-center text-sm font-semibold tracking-wide ${subtle?"text-slate-500":"text-slate-700"}`}>
        {label}
        {missing && <span className="ml-1 text-red-500">*</span>}
        {smart && <span title={typeof smart === 'string' ? smart : "Automatically updates"} className="ml-1.5 text-orange-500 text-xs cursor-help">‚ö°</span>}
        </label>
        {action}
    </div>
    {children}
  </div>
);

const Input = (props) => <input {...props} className={`w-full rounded-lg border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-700 shadow-sm transition-all duration-200 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 hover:border-slate-300 ${props.className||""}`} />;
const Select = ({children, ...props}) => <select {...props} className={`w-full rounded-lg border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-700 shadow-sm transition-all duration-200 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 hover:border-slate-300 ${props.className||""}`}>{children}</select>;
const Textarea = (props) => <textarea {...props} className={`w-full min-h-[80px] resize-y rounded-lg border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-700 shadow-sm transition-all duration-200 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 hover:border-slate-300 ${props.className||""}`} />;

const SearchSelect = ({ value, onChange, options, placeholder, listId, className }) => (
  <div className={`relative ${className||""}`}>
    <Input
      list={listId}
      value={value || ""}
      onChange={e => onChange(e.target.value)}
      placeholder={placeholder || "Type to search..."}
      className="pr-10"
    />
    <datalist id={listId}>
      {options.map(opt => <option key={opt} value={opt} />)}
    </datalist>
    <span className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-slate-300">‚ñæ</span>
  </div>
);

const Toast = ({message,onClose})=>{ 
  useEffect(()=>{ const id=setTimeout(onClose,2600); return ()=>clearTimeout(id);},[onClose]); 
  return(<div className="fade-in fixed bottom-28 left-1/2 z-[90] -translate-x-1/2 rounded-full bg-slate-800/90 backdrop-blur px-6 py-2.5 text-sm font-medium text-white shadow-xl shadow-slate-500/20">{message}</div>) 
};

const Switch = ({ checked, onChange }) => (
    <button 
        onClick={() => onChange(!checked)} 
        className={`relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none ${checked ? 'bg-indigo-600' : 'bg-slate-200'}`}
    >
        <span className={`pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${checked ? 'translate-x-5' : 'translate-x-0'}`} />
    </button>
);

const SmartNotification = ({ message, onReject, onClose }) => {
    useEffect(() => {
        const timer = setTimeout(onClose, 4000);
        return () => clearTimeout(timer);
    }, [onClose]);

    return (
        <div className="fixed bottom-24 left-1/2 z-[90] -translate-x-1/2 flex items-center gap-4 rounded-lg bg-slate-900 px-4 py-3 text-white shadow-2xl slide-up border border-slate-700">
            <div className="flex items-center gap-3">
                <div className="text-orange-500 font-bold text-lg">‚ö°</div>
                <span className="text-sm font-medium">{message}</span>
            </div>
            <div className="h-4 w-px bg-slate-700"></div>
            <button onClick={onReject} className="rounded px-2 py-1 text-xs font-bold text-slate-300 hover:bg-slate-800 hover:text-white transition-colors uppercase tracking-wider">Reject</button>
        </div>
    );
};

const pillBase = "inline-flex items-center gap-2 rounded-full border px-4 py-1.5 text-sm font-medium transition-all duration-200 cursor-pointer select-none";
const pillInactive = "border-slate-200 bg-white text-slate-600 hover:border-slate-300 hover:bg-slate-50";
const pillActive = "bg-indigo-50 border-indigo-600 text-indigo-700 font-bold shadow-sm animate-outline-fade-indigo"; 

const ToggleGroup = ({ options, value, onChange }) => (
  <div className="flex flex-wrap gap-2">
    {options.map(opt => {
       const isActive = value === opt;
       return (<div key={opt} onClick={() => onChange(isActive ? "" : opt)} className={isActive ? `${pillBase} ${pillActive}` : `${pillBase} ${pillInactive}`}>
         {isActive && <span className="block h-1.5 w-1.5 rounded-full bg-indigo-600 mr-2"></span>}
         {opt}
       </div>)
    })}
  </div>
);

const ToggleMulti = ({ label, checked, onChange, className, colorClass }) => {
    const activeClass = colorClass || pillActive;
    return (
        <div onClick={onChange} className={(checked ? `${pillBase} ${activeClass}` : `${pillBase} ${pillInactive}`) + " " + (className||"")}> 
            {checked && <span className="block h-1.5 w-1.5 rounded-full bg-indigo-600 mr-2"></span>}
            {label}
        </div>
    );
};

const SubSection = ({ title, open, onToggle, children, compact }) => (
  <div className={`rounded-xl border border-slate-200 bg-white ${compact ? "p-3" : "p-5"} shadow-sm`}>
    <button onClick={onToggle} className="flex w-full items-center justify-between text-left">
      <span className="text-sm font-bold text-slate-700">{title}</span>
      <span className="text-slate-400">{open ? "‚ñæ" : "‚Ä∫"}</span>
    </button>
    {open && <div className={`mt-4 ${compact ? "space-y-3" : "space-y-4"} fade-in`}>{children}</div>}
  </div>
);

// --- SHARED FIELD COMPONENTS ---

const LeadInfoFields = memo(({ data, update, companies, setModal, toggleMulti, showInlineHelp }) => (
  <div className="rounded-xl border border-slate-200 bg-white p-5 shadow-sm space-y-6">
      <div className="flex flex-col gap-2 items-start">
         <div className="flex justify-between w-full items-center">
            <label className="text-sm font-bold text-indigo-800">Record Type</label>
            {showInlineHelp ? (
                <span className="text-[10px] text-slate-400 font-medium italic">Leads can become Orders later</span>
            ) : (
                <div className="group relative">
                    <div className="cursor-help w-4 h-4 rounded-full border border-slate-300 text-slate-400 flex items-center justify-center text-[10px] font-serif hover:bg-slate-100 hover:text-slate-600 italic">i</div>
                    <div className="absolute right-0 top-6 w-40 p-2 bg-slate-800 text-white text-[10px] rounded shadow-xl opacity-0 group-hover:opacity-100 transition-opacity z-10 pointer-events-none">
                        Leads can be transferred to Orders later. Use Order for billable work.
                    </div>
                </div>
            )}
         </div>
         <ToggleGroup options={["Lead", "Order"]} value={data.isLead ? "Lead" : "Order"} onChange={v => update("isLead", v === "Lead")} />
      </div>

      <div className="border-t border-slate-100"></div>

      <Field label="Source">
          <div className="flex flex-wrap justify-start gap-2">
               {LEAD_SOURCES.map(s => <ToggleMulti key={s} label={s} checked={data.leadSourceCategory === s} onChange={() => update("leadSourceCategory", s)} />)}
          </div>
      </Field>

      {data.leadSourceCategory === "Referral" && (
           <div className="grid gap-4 animate-indigo-fade p-4 rounded-lg bg-indigo-50/30 border border-indigo-100">
                            <Field label="Referring Company">
                              <div className="flex gap-2">
                                <SearchSelect value={data.referringCompany} onChange={(v)=>update("referringCompany",v)} options={DEFAULT_COMPANIES.concat(companies.filter(c=>!DEFAULT_COMPANIES.includes(c)))} listId="referring-company-list" />
                                <button className="rounded-lg bg-white px-3 font-bold text-indigo-600 shadow-sm hover:bg-indigo-50" onClick={()=>setModal({type:"company",value:"",onSave:(name)=>update("referringCompany",name)})}>+</button>
                              </div>
                            </Field>
               <Field label="Referrer Name"><Input className={data.highlightMissing?.referrer ? "audit-missing" : ""} value={data.referrer} onChange={e=>update("referrer",e.target.value)} /></Field>
           </div>
       )}
       {data.leadSourceCategory === "Marketing" && (
           <div className="animate-indigo-fade p-4 rounded-lg bg-indigo-50/30 border border-indigo-100"><Field label="Channel"><div className="flex flex-wrap gap-2">{MARKETING_SOURCES.map(s => <ToggleMulti key={s} label={s} checked={data.leadSourceDetail === s} onChange={() => update("leadSourceDetail", s)} />)}</div></Field></div>
       )}
       {data.leadSourceCategory === "Internal" && (
           <div className="animate-indigo-fade p-4 rounded-lg bg-indigo-50/30 border border-indigo-100"><Field label="Type"><div className="flex flex-wrap gap-2">{INTERNAL_TYPES.map(s => <ToggleMulti key={s} label={s} checked={data.leadSourceDetail === s} onChange={() => update("leadSourceDetail", s)} />)}</div></Field></div>
       )}

      <Field label="Method">
          <div className="flex flex-wrap justify-start gap-2">
               {CONTACT_METHODS.map(m => <ToggleMulti key={m} label={m} checked={data.contactMethod === m} onChange={() => update("contactMethod", m)} />)}
          </div>
      </Field>
  </div>
));

const QuickScopeFields = memo(({ data, update, toggleMulti }) => (
    <div className="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
        <h3 className="mb-3 text-sm font-bold uppercase text-slate-500 tracking-wider">Quick Scope Notes</h3>
        <div className="flex flex-wrap gap-2">
            {["Everything Impacted", "Save what you can", "Determine Impact", "Only specific items"].map(n => (
                <ToggleMulti key={n} label={n} checked={(data.quickScopeNotes||[]).includes(n)} onChange={()=>update("quickScopeNotes", toggleMulti(data.quickScopeNotes||[], n))} />
            ))}
        </div>
    </div>
));

const LoadListFields = memo(({ data, update, toggleMulti }) => (
    <div className="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
         <h3 className="mb-3 text-sm font-bold uppercase text-slate-500 tracking-wider">To Bring (Load List)</h3>
         <div className="flex flex-wrap gap-2">
             <ToggleMulti label="Heater" checked={(data.loadList||[]).includes("Heater")} onChange={()=>update("loadList", toggleMulti(data.loadList||[], "Heater"))} className={data.noHeat ? "animate-orange-highlight !border-orange-500 !bg-orange-50 !text-orange-700" : ""} />
             <ToggleMulti label="Ladder" checked={(data.loadList||[]).includes("Ladder")} onChange={()=>update("loadList", toggleMulti(data.loadList||[], "Ladder"))} />
             <ToggleMulti label="Lights" checked={(data.loadList||[]).includes("Lights")} onChange={()=>update("loadList", toggleMulti(data.loadList||[], "Lights"))} className={data.noLights || data.boardedUp ? "animate-orange-highlight !border-orange-500 !bg-orange-50 !text-orange-700" : ""} />
             <ToggleMulti label="Tyvek" checked={(data.loadList||[]).includes("Tyvek")} onChange={()=>update("loadList", toggleMulti(data.loadList||[], "Tyvek"))} className={(data.orderTypes||[]).includes('Mold') ? "animate-orange-highlight !border-orange-500 !bg-orange-50 !text-orange-700" : ""} />
             <ToggleMulti label="Plastic Bags" checked={(data.loadList||[]).includes("Plastic Bags")} onChange={()=>update("loadList", toggleMulti(data.loadList||[], "Plastic Bags"))} className={data.damageWasWet === "Y" || (data.orderTypes||[]).includes('Mold') ? "animate-orange-highlight !border-orange-500 !bg-orange-50 !text-orange-700" : ""} />
         </div>
    </div>
));

// --- START SCREEN ---
const StartScreen = ({ onSelect }) => (
  <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 px-4 fade-in scale-in">
    <div className="text-center mb-12">
      <h1 className="text-5xl font-extrabold text-slate-900 mb-2 tracking-tight">New Order Entry</h1>
      <p className="text-lg text-slate-500">Choose your entry mode</p>
    </div>
    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
      <button 
        onClick={() => onSelect('quick')}
        className="group relative flex flex-col items-center p-10 rounded-3xl bg-white border border-slate-200 shadow-xl hover:shadow-2xl hover:border-indigo-300 hover:-translate-y-1 transition-all duration-300"
      >
        <div className="h-20 w-20 mb-6 rounded-full bg-indigo-50 flex items-center justify-center text-4xl group-hover:scale-110 transition-transform">‚ö°</div>
        <h2 className="text-2xl font-bold text-slate-800 mb-3">Quick Entry</h2>
        <p className="text-center text-slate-500">Rapid data capture. Basic details, location, and scheduling.</p>
        <div className="mt-6 opacity-0 group-hover:opacity-100 transition-opacity text-indigo-600 font-bold text-sm">Start Fast ‚Üí</div>
      </button>
      <button 
        onClick={() => onSelect('detailed')}
        className="group relative flex flex-col items-center p-10 rounded-3xl bg-white border border-slate-200 shadow-xl hover:shadow-2xl hover:border-purple-400 hover:-translate-y-1 transition-all duration-300"
      >
        <div className="h-20 w-20 mb-6 rounded-full bg-purple-50 flex items-center justify-center text-4xl group-hover:scale-110 transition-transform">üìù</div>
        <h2 className="text-2xl font-bold text-slate-800 mb-3">Detailed Entry</h2>
        <p className="text-center text-slate-500">Full interview process. Smart triggers, detailed conditions, and billing.</p>
        <div className="mt-6 opacity-0 group-hover:opacity-100 transition-opacity text-purple-600 font-bold text-sm">Start Detailed ‚Üí</div>
      </button>
    </div>
  </div>
);

// --- SEARCH COMPONENT ---
const GlobalSearch = ({ show, onClose, onNavigate, onSearchHit }) => {
  const [query, setQuery] = useState("");
  const inputRef = useRef(null);

  useEffect(() => {
    if(show && inputRef.current) inputRef.current.focus();
  }, [show]);

  const searchableItems = [
    { id: 'sec1', label: 'Order Info', keywords: 'order name type' },
    { id: 'sec1-loss', label: 'Loss Type: Fire', keywords: 'fire smoke soot battery candle cooking electrical explosion fireplace flammables heating neighbor protein smoking wildfire', action: () => onSearchHit('Fire') },
    { id: 'sec1-loss', label: 'Loss Type: Water', keywords: 'water leak roof window frozen pipe burst overflow storm', action: () => onSearchHit('Water') },
    { id: 'sec1-loss', label: 'Loss Type: Mold', keywords: 'mold spores visible odor', action: () => onSearchHit('Mold') },
    { id: 'sec1-interview', label: 'Interview', keywords: 'living staying temp moving repairs packout conditions' },
    { id: 'sec1-codes', label: 'Order Codes', keywords: 'handling severity quality box damp' },
    { id: 'sec2', label: 'Customer', keywords: 'customer name phone email contact' },
    { id: 'sec3', label: 'Address', keywords: 'address street city state zip location' },
    { id: 'sec4', label: 'Billing', keywords: 'billing insurance payer claim adjuster' },
    { id: 'sec5', label: 'Schedule', keywords: 'schedule date time tech instructions estimate' },
    { id: 'quick', label: 'Quick Entry', keywords: 'quick fast entry load list' }
  ];

  const filtered = searchableItems.filter(s => 
    s.label.toLowerCase().includes(query.toLowerCase()) || 
    s.keywords.includes(query.toLowerCase())
  );

  if (!show) return null;

  return (
    <div className="fixed inset-0 z-[100] flex items-start justify-center bg-slate-900/40 backdrop-blur-sm pt-24 fade-in" onClick={onClose}>
       <div className="w-full max-w-xl rounded-2xl bg-white/80 backdrop-blur-xl p-4 shadow-2xl ring-1 ring-black/5 border border-white/40" onClick={e=>e.stopPropagation()}>
          <div className="flex items-center gap-3 border-b border-slate-200/60 pb-3 mb-3">
             <span className="text-slate-500 text-xl">üîç</span>
             <input 
               ref={inputRef}
               className="flex-1 bg-transparent text-xl font-medium outline-none placeholder:text-slate-400 text-slate-800"
               placeholder="Search fields, sections..."
               value={query}
               onChange={e=>setQuery(e.target.value)}
               onKeyDown={e => {
                  if(e.key === 'Enter' && filtered.length > 0) {
                      const item = filtered[0];
                      if(item.action) item.action();
                      onNavigate(item.id);
                      onClose();
                  }
                  if(e.key === 'Escape') onClose();
               }}
             />
             <span className="text-[10px] font-bold text-slate-400 border border-slate-300 rounded px-1.5 py-0.5 bg-slate-50">ESC</span>
          </div>
          <div className="space-y-1 max-h-[400px] overflow-y-auto custom-scroll">
             {filtered.map((s, idx) => (
               <button 
                 key={idx}
                 onClick={() => { 
                     if(s.action) s.action();
                     onNavigate(s.id); 
                     onClose(); 
                 }}
                 className={`w-full flex items-center justify-between p-3 rounded-lg text-left transition-all group ${idx === 0 ? 'bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-100' : 'hover:bg-white/50 hover:shadow-sm'}`}
               >
                  <span className={`font-semibold ${idx === 0 ? 'text-indigo-700' : 'text-slate-700'}`}>{s.label}</span>
                  {idx === 0 && <span className="text-[10px] font-bold text-indigo-400 uppercase tracking-wider group-hover:text-indigo-600">Hit Enter</span>}
               </button>
             ))}
             {filtered.length === 0 && <div className="text-center py-4 text-slate-500 text-sm">No results found.</div>}
          </div>
       </div>
    </div>
  );
};

// --- UNIFIED FLOATING HEADER (PROGRESS HEADER) ---
const Header = ({ activeSection, visitedSections, onJump, title, version, entryMode, setEntryMode, showInlineHelp, setShowInlineHelp, compactMode, setCompactMode }) => {
    const steps = [
        { id: 'sec1', label: 'Order' },
        { id: 'sec2', label: 'Customer' },
        { id: 'sec3', label: 'Address' },
        { id: 'sec4', label: 'Billing' },
        { id: 'sec5', label: 'Schedule' },
    ];

    const getStatus = (stepId) => {
        if (stepId === activeSection) return 'active';
        if (visitedSections.has(stepId)) return 'visited';
        return 'future';
    };

    return (
        <header className="fixed top-0 left-0 right-0 z-50 bg-white/60 backdrop-blur-xl border-b border-slate-200 shadow-md shadow-slate-900/5">
            <div className="max-w-6xl mx-auto px-4 pt-4 pb-6 flex items-center justify-between gap-6">
                <div className="flex items-center gap-4 min-w-[120px]">
                     <button onClick={() => setEntryMode('start')} className="text-slate-400 hover:text-slate-600 transition-colors p-2 rounded-full hover:bg-slate-100">
                        <span className="text-lg">‚Üê</span>
                     </button>
                     <div className="flex flex-col">
                         <h1 className="text-base font-bold text-slate-900 leading-none">{title}</h1>
                         <span className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mt-0.5">{version}</span>
                     </div>
                </div>

                {entryMode === 'detailed' && (
                    <div className="flex-1 flex items-center justify-center max-w-xl">
                        <div className="flex items-center w-full relative">
                             {steps.map((step, idx) => {
                                const status = getStatus(step.id);
                                const isLast = idx === steps.length - 1;
                                let circleClass = "bg-white border-slate-300 text-slate-400 group-hover:border-slate-400";
                                if (status === 'active') circleClass = "bg-purple-600 border-purple-600 text-white shadow-md scale-110";
                                else if (status === 'visited') circleClass = "bg-white border-2 border-purple-600 text-purple-600";

                                return (
                                    <React.Fragment key={step.id}>
                                        <div className="flex-1 flex items-center relative last:flex-none">
                                            <button onClick={() => onJump(step.id)} className="group flex flex-col items-center gap-1 focus:outline-none z-10 relative">
                                                <div className={`flex h-8 w-8 items-center justify-center rounded-full text-xs font-bold transition-all duration-300 border ${circleClass}`}>
                                                    {status === 'visited' && status !== 'active' ? '‚úì' : idx + 1}
                                                </div>
                                                <span className={`absolute top-9 text-[9px] font-bold uppercase tracking-wider transition-all duration-300 whitespace-nowrap ${status === 'active' ? 'text-purple-700 opacity-100' : 'text-slate-400 opacity-100 block'}`}>
                                                    {step.label}
                                                </span>
                                            </button>
                                            {!isLast && (
                                                <div className="flex-1 h-[2px] bg-slate-200 mx-2 rounded relative overflow-hidden">
                                                    <div className={`absolute left-0 top-0 h-full bg-purple-600 transition-all duration-500`} style={{ width: status === 'visited' || status === 'active' ? '100%' : '0%' }}></div>
                                                </div>
                                            )}
                                        </div>
                                    </React.Fragment>
                                );
                            })}
                        </div>
                    </div>
                )}
                
                {entryMode !== 'detailed' && <div className="flex-1"></div>}

                <div className="min-w-[120px] flex justify-end gap-2">
                    <button 
                        onClick={() => setShowInlineHelp(!showInlineHelp)} 
                        className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all border ${showInlineHelp ? 'bg-indigo-50 text-indigo-600 border-indigo-200' : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}`}
                    >
                        <span>{showInlineHelp ? 'Help: Visible' : 'Help: Icon'}</span>
                    </button>
                    <button
                        onClick={() => setCompactMode(!compactMode)}
                        className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all border ${compactMode ? 'bg-rose-50 text-rose-600 border-rose-200' : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}`}
                    >
                        <span>{compactMode ? 'Density: Compact' : 'Density: Comfortable'}</span>
                    </button>
                </div>
            </div>
        </header>
    );
};

// --- FLOATING CAPSULE BAR (Bottom) ---
const FloatingCapsule = ({ entryMode, setEntryMode, onSave, onAudit, auditOn, setShowSearch }) => {
    const [expanded, setExpanded] = useState(true);

    return (
        <div className="fixed bottom-8 left-0 right-0 z-50 flex justify-center pointer-events-none fade-in">
            <div className={`pointer-events-auto bg-white border border-slate-200 shadow-[0_8px_30px_rgb(0,0,0,0.15)] shadow-slate-700/30 rounded-full flex items-center p-1.5 gap-2 transition-all duration-500 ease-out ${expanded ? 'px-3' : 'px-2'}`}>
                
                <button 
                    onClick={() => setExpanded(!expanded)} 
                    className="h-10 w-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors"
                    title={expanded ? "Collapse" : "Expand"}
                >
                    <span className={`transform transition-transform duration-300 ${expanded ? 'rotate-180' : 'rotate-0'}`}>‚Ä∫</span>
                </button>

                <div className="h-6 w-px bg-slate-200 mx-1"></div>

                <button onClick={() => setShowSearch(true)} className={`flex items-center justify-center h-10 rounded-full transition-all hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 ${expanded ? 'px-4 gap-2 bg-slate-50' : 'w-10'}`}>
                    <span className="text-lg">üîç</span>
                    {expanded && <span className="text-sm font-bold">Search</span>}
                </button>

                <button 
                    onClick={() => setEntryMode(entryMode === 'quick' ? 'detailed' : 'quick')} 
                    className={`flex items-center justify-center h-10 rounded-full transition-all hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 ${expanded ? 'px-4 gap-2 bg-slate-50' : 'w-10'}`}
                >
                    <span className="text-lg">{entryMode === 'quick' ? '‚ö°' : 'üìù'}</span>
                    {expanded && <span className="text-sm font-bold">{entryMode === 'quick' ? 'Detailed' : 'Quick'}</span>}
                </button>

                <button onClick={onAudit} className={`flex items-center justify-center h-10 rounded-full transition-all ${auditOn ? 'bg-rose-50 text-rose-600 border border-rose-200' : 'hover:bg-indigo-50 text-slate-600 hover:text-indigo-600'} ${expanded ? 'px-4 gap-2' : 'w-10'}`}>
                    <span className="text-lg">üìã</span>
                    {expanded && <span className="text-sm font-bold">{auditOn ? 'Audit: On' : 'Audit'}</span>}
                </button>

                <button onClick={onSave} className={`flex items-center justify-center h-10 rounded-full bg-indigo-600 text-white shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all ${expanded ? 'px-6 gap-2' : 'w-10'}`}>
                    <span className="text-lg">üíæ</span>
                    {expanded && <span className="text-sm font-bold">Save</span>}
                </button>

            </div>
        </div>
    );
};


const Section = ({ id, title, isOpen, onToggle, children, badges, className, compact }) => (
  <div id={id} className={`mb-0 overflow-hidden rounded-none border-y border-slate-200 bg-white shadow-sm transition-shadow duration-300 scroll-mt-28 sm:mb-4 sm:rounded-xl sm:border ${isOpen ? 'ring-1 ring-indigo-600/20 shadow-md' : ''} ${className||""}`}>
    <button className={`flex w-full cursor-pointer items-center justify-between px-4 py-4 sm:px-6 sm:py-5 text-left font-semibold text-slate-800 transition-colors ${compact ? "section-header-tight" : ""} ${isOpen ? "bg-white" : "bg-slate-50/50 hover:bg-slate-50"}`} onClick={onToggle}>
      <div className="flex items-center gap-3">
        <span className={`text-lg ${isOpen ? "text-slate-900" : "text-slate-700"}`}>{title}</span>
        {badges}
      </div>
      <Chevron open={isOpen} />
    </button>
    {isOpen && <div className={`border-t border-slate-100 ${compact ? 'p-3 sm:p-4' : 'p-4 sm:p-6'} fade-in`}>{children}</div>}
  </div>
);

// --- SUB-COMPONENTS ---
const CustomerItem = memo(({ c, index, total, updateCust, onRemove, highlightMissing }) => {
  return (
    <div className={`group relative rounded-lg sm:rounded-xl border bg-white p-3 sm:p-5 shadow-sm transition-all hover:border-indigo-300 hover:shadow-md ${c.isPrimary ? "border-indigo-400 ring-1 ring-indigo-50" : "border-slate-200"}`}>
      {c.isPrimary && <div className="absolute left-0 top-0 bottom-0 w-1 bg-indigo-500 rounded-l-lg"></div>}
      {total > 1 && ( <button onClick={() => onRemove(c.id, index)} className="absolute right-3 top-3 grid h-7 w-7 place-items-center rounded-full bg-slate-100 text-slate-400 hover:bg-red-50 hover:text-red-600 transition-colors">√ó</button> )}
      
      <div className="mb-4 flex flex-col gap-3 pl-1 sm:pl-2 sm:flex-row sm:items-center sm:justify-between">
         <div className="flex items-center gap-2">
            <div className="flex h-8 w-8 items-center justify-center rounded-full bg-indigo-100 text-xs font-bold text-indigo-600">{index + 1}</div>
            <span className="text-sm font-semibold text-slate-800">{c.first && c.last ? `${c.first} ${c.last}` : "Customer"}</span>
         </div>
         <div className="flex flex-wrap gap-2">
            <ToggleMulti className="!py-1 !px-2 sm:!px-3 !text-xs" label="Primary" checked={!!c.isPrimary} onChange={()=>updateCust(c.id, { isPrimary: true })} colorClass="!bg-indigo-600 !border-indigo-600 !text-white" />
            <ToggleMulti className="!py-1 !px-2 sm:!px-3 !text-xs" label="Policy Holder" checked={!!c.policyHolder} onChange={()=>updateCust(c.id, { policyHolder: !c.policyHolder, type: !c.policyHolder ? "Policyholder" : c.type })} />
            <ToggleMulti className="!py-1 !px-2 sm:!px-3 !text-xs" label="Self Pay" checked={!!c.selfPay} onChange={()=>updateCust(c.id, { selfPay: !c.selfPay, type: !c.selfPay ? "Owner" : c.type })} />
         </div>
      </div>

      <div className="grid gap-4 pl-1 sm:pl-2">
         <div className="w-full sm:w-1/2">
            <label className="text-xs font-semibold text-slate-500 mb-1 block">Type</label>
            <Select value={c.type || ""} onChange={e=>updateCust(c.id,{type:e.target.value})}>
                <option value="" disabled>Select Relationship</option>
                {CUSTOMER_TYPES.map(t=><option key={t} value={t}>{t}</option>)}
            </Select>
         </div>

         <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
            <Field label="Last Name"><Input className={index===0 && highlightMissing?.custLast ? "audit-missing" : ""} value={c.last} onChange={e=>updateCust(c.id,{last:e.target.value})} /></Field>
            <Field label="First Name"><Input className={index===0 && highlightMissing?.custFirst ? "audit-missing" : ""} value={c.first} onChange={e=>updateCust(c.id,{first:e.target.value})} /></Field>
         </div>

         <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
             <div className="flex flex-col gap-1.5">
                <div className="flex justify-between items-center"><label className="text-sm font-semibold text-slate-700">Phone</label><button className="text-xs text-indigo-600 font-bold hover:text-indigo-700">+ Add</button></div>
                <div className="flex gap-2">
                    <div className="w-1/3"><Select value={c.phoneType} onChange={(e) => updateCust(c.id, { phoneType: e.target.value })}><option>Mobile</option><option>Home</option><option>Work</option></Select></div>
                    <Input className={`flex-1 ${index===0 && highlightMissing?.custPhone ? "audit-missing" : ""}`} type="tel" value={c.phone} onChange={e=>updateCust(c.id,{phone: formatPhoneNumber(e.target.value)})} maxLength={14} placeholder="(555) 123-4567" />
                </div>
             </div>
             <div className="flex flex-col gap-1.5">
                <div className="flex justify-between items-center"><label className="text-sm font-semibold text-slate-700">Email</label><button className="text-xs text-indigo-600 font-bold hover:text-indigo-700">+ Add</button></div>
                <Input className={index===0 && highlightMissing?.custEmail ? "audit-missing" : ""} type="email" value={c.email} onChange={e=>updateCust(c.id,{email:e.target.value})} placeholder="user@example.com" />
             </div>
         </div>

         <Field label="Preferred Contact Method">
             <div className="flex flex-wrap gap-2">
                 {["Phone", "Email", "Text"].map(m => (
                     <ToggleMulti key={m} label={m} checked={c.preferredMethod === m} onChange={() => updateCust(c.id, { preferredMethod: m })} colorClass="!bg-indigo-600 !border-indigo-600 !text-white" />
                 ))}
             </div>
         </Field>

         <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
             <span className="text-sm font-bold text-slate-700">Send Welcome Text</span>
             <Switch checked={c.sendWelcomeText} onChange={(val) => updateCust(c.id, { sendWelcomeText: val })} />
         </div>

         <Field label="Notes">
             <Textarea value={c.note} onChange={e => updateCust(c.id, { note: e.target.value })} placeholder="Add notes about this customer..." />
         </Field>

         <div className="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
             <div className="flex items-center justify-between mb-2">
                 <span className="text-sm font-bold text-emerald-800">Household Members (Quick Add)</span>
             </div>
             <button className="text-xs font-bold text-emerald-700 hover:text-emerald-800 flex items-center gap-1">
                 <span>+</span> Add Person
             </button>
         </div>

      </div>
    </div>
  );
});

const AddressItem = memo(({ addr, total, updateAddr, onRemove, highlightMissing, index, onVerify }) => {
  return (
    <div className={`group relative overflow-hidden rounded-lg sm:rounded-xl border bg-white p-3 sm:p-5 shadow-sm transition-all hover:shadow-md ${addr.isPrimary ? "border-indigo-400 ring-1 ring-indigo-50" : "border-slate-200"}`}>
      {addr.isPrimary && <div className="absolute left-0 top-0 bottom-0 w-1 bg-indigo-500 rounded-l-lg"></div>}
      {total > 1 && ( <button onClick={()=>onRemove(addr.id)} className="absolute right-3 top-3 grid h-7 w-7 place-items-center rounded-full bg-slate-100 text-slate-400 hover:bg-red-50 hover:text-red-600 transition-colors">√ó</button> )}
      <div className="mb-4 pl-1 sm:pl-2 flex items-center gap-2">
         <span className="text-sm font-bold text-slate-800">{addr.street || "Address"}</span>
         {addr.isPrimary && <span className="rounded bg-indigo-100 px-2 py-0.5 text-[10px] font-bold uppercase text-indigo-700">Primary</span>}
         {addr.isLossSite && <span className="rounded bg-rose-100 px-2 py-0.5 text-[10px] font-bold uppercase text-rose-700">Loss Site</span>}
      </div>
      <div className="grid gap-4 pl-1 sm:pl-2">
        <div className="flex flex-wrap items-end gap-3">
          <div className="flex-1 min-w-[140px]">
            <Field label="Type"><Select value={addr.type} onChange={e=>updateAddr(addr.id,{type:e.target.value})}><option value="" disabled>Select Type...</option>{["House","Apartment","Garden Apartment","Row House","Neighbor","Hotel","Temp","Work","Other"].map(t=><option key={t} value={t}>{t}</option>)}</Select></Field>
          </div>
          <div className="flex-1"><Field label="Location Status"><div className="flex gap-2"><ToggleMulti label="Primary" checked={!!addr.isPrimary} onChange={()=>updateAddr(addr.id,{isPrimary:!addr.isPrimary})} colorClass="!bg-indigo-600 !border-indigo-600 !text-white" /><ToggleMulti label="Loss Site" checked={!!addr.isLossSite} onChange={()=>updateAddr(addr.id,{isLossSite:!addr.isLossSite})} /></div></Field></div>
        </div>
        <div className="grid grid-cols-1 gap-4 sm:grid-cols-2"><Field label="Street Address"><Input className={index===0 && highlightMissing?.addrStreet ? "audit-missing" : ""} value={addr.street} onChange={e=>updateAddr(addr.id,{street:e.target.value})} /></Field><Field label="Apt / Unit #"><Input value={addr.apt} onChange={e=>updateAddr(addr.id,{apt:e.target.value})} /></Field></div>
        <div className="grid grid-cols-3 gap-4">
           <div className="col-span-1"><Field label="City"><Input className={index===0 && highlightMissing?.addrCity ? "audit-missing" : ""} value={addr.city} onChange={e=>updateAddr(addr.id,{city:e.target.value})} /></Field></div>
           <div className="col-span-1"><Field label="State"><Select className={index===0 && highlightMissing?.addrState ? "audit-missing" : ""} value={addr.state} onChange={e=>updateAddr(addr.id,{state:e.target.value})}><option value="">Select</option>{STATES.map(s=><option key={s} value={s}>{s}</option>)}</Select></Field></div>
           <div className="col-span-1"><Field label="Zip"><Input className={index===0 && highlightMissing?.addrZip ? "audit-missing" : ""} value={addr.zip} onChange={e=>updateAddr(addr.id,{zip:e.target.value})} inputMode="numeric" pattern="\d{5}" /></Field></div>
        </div>
        <div className="grid grid-cols-2 gap-4">
           <div className="col-span-1"><Field label="Latitude"><Input className={index===0 && highlightMissing?.addrLat ? "audit-missing" : ""} value={addr.lat} onChange={e=>updateAddr(addr.id,{lat:e.target.value})} placeholder="e.g. 40.8874" /></Field></div>
           <div className="col-span-1"><Field label="Longitude"><Input className={index===0 && highlightMissing?.addrLng ? "audit-missing" : ""} value={addr.lng} onChange={e=>updateAddr(addr.id,{lng:e.target.value})} placeholder="e.g. -74.0291" /></Field></div>
        </div>
        <div className="flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">
           <div className="text-xs text-slate-500">Verify address and auto-fill lat/long (demo)</div>
           <button onClick={() => onVerify?.(addr.id)} className="rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-bold text-white shadow-sm hover:bg-indigo-700">Verify</button>
        </div>
      </div>
    </div>
  );
});

// --- QUICK ENTRY COMPONENT ---
const QuickEntry = ({ data, update, updateAddr, updateCust, companies, setModal, toggleMulti, updateSmart, handleConfirmClick, setToast, showInlineHelp }) => {
    const primaryAddr = data.addresses && data.addresses.length > 0 ? data.addresses[0] : {};
    const quickNotes = [
        "Gate code needed",
        "Call upon arrival",
        "Parking in rear",
        "Beware of pets",
        "Owner on-site",
    ];

    const appendQuickNote = (note) => {
        const nextNotes = toggleMulti(data.quickInstructionNotes || [], note);
        update("quickInstructionNotes", nextNotes);
        const base = (data.eventInstructions || "").trim();
        const add = nextNotes.includes(note);
        if (add) {
            const combined = base ? `${base} ${note}` : note;
            update("eventInstructions", combined.trim());
        } else {
            const cleaned = base.replace(note, "").replace(/\s{2,}/g, " ").trim();
            update("eventInstructions", cleaned);
        }
    };

    return (
        <div className="space-y-6 fade-in pt-4">
            <LeadInfoFields data={data} update={update} companies={companies} setModal={setModal} toggleMulti={toggleMulti} showInlineHelp={showInlineHelp} />

            <div className="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
                <h3 className="mb-4 text-sm font-bold uppercase text-indigo-600">Quick Flags</h3>
                <div className="grid gap-4 sm:grid-cols-2">
                    <Field label="Restoration Project?">
                        <ToggleGroup options={["Y", "N"]} value={data.isRestorationProject} onChange={v => update("isRestorationProject", v)} />
                    </Field>
                    <Field label="Going Through Insurance?">
                        <ToggleGroup options={["Yes", "No", "TBD"]} value={data.insuranceStatus} onChange={v => update("insuranceStatus", v)} />
                    </Field>
                </div>
                {data.isLead && (
                    <div className="mt-4 rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700">
                        Leads can‚Äôt be scheduled yet. Switch to Order to enable scheduling.
                    </div>
                )}
            </div>

            <div className="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
                <h3 className="mb-4 text-sm font-bold uppercase text-indigo-600">Customer</h3>
                <div className="grid gap-4 sm:grid-cols-2">
                    <Field label="First Name">
                        <Input value={data.customers?.[0]?.first || ""} onChange={e=>updateCust(data.customers?.[0]?.id, { first: e.target.value })} />
                    </Field>
                    <Field label="Last Name">
                        <Input value={data.customers?.[0]?.last || ""} onChange={e=>updateCust(data.customers?.[0]?.id, { last: e.target.value })} />
                    </Field>
                    <Field label="Phone">
                        <Input value={data.customers?.[0]?.phone || ""} onChange={e=>updateCust(data.customers?.[0]?.id, { phone: formatPhoneNumber(e.target.value) })} placeholder="(555) 123-4567" />
                    </Field>
                    <Field label="Email">
                        <Input type="email" value={data.customers?.[0]?.email || ""} onChange={e=>updateCust(data.customers?.[0]?.id, { email: e.target.value })} placeholder="user@example.com" />
                    </Field>
                </div>
            </div>

            <div className="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
                 <h3 className="mb-4 text-sm font-bold uppercase text-indigo-600">Address</h3>
                 <div className="grid gap-4">
                    <div className="rounded-lg border border-indigo-50 bg-indigo-50/50 p-2">
                        <Field label="Find on Google" subtle className="text-indigo-700">
                             <div className="flex gap-2">
                                <Input placeholder="Start typing address..." value={primaryAddr.googleQuery || ""} onChange={e=>updateAddr(primaryAddr.id,{googleQuery:e.target.value})} />
                                <button className="rounded-lg bg-indigo-600 px-4 py-2 text-xs font-bold text-white shadow-sm hover:bg-indigo-700 transition-all" onClick={()=>updateAddr(primaryAddr.id,{street:"1 Main St",city:"Bloomingdale",state:"NJ",zip:"07403"})}>Search</button>
                             </div>
                        </Field>
                    </div>
                    <Field label="Street"><Input value={primaryAddr.street || ""} onChange={e=>updateAddr(primaryAddr.id,{street:e.target.value})} /></Field>
                    <div className="grid grid-cols-3 gap-2">
                       <div className="col-span-1"><Input placeholder="City" value={primaryAddr.city || ""} onChange={e=>updateAddr(primaryAddr.id,{city:e.target.value})} /></div>
                       <div className="col-span-1"><Select value={primaryAddr.state || ""} onChange={e=>updateAddr(primaryAddr.id,{state:e.target.value})}><option value="">State</option>{STATES.map(s=><option key={s} value={s}>{s}</option>)}</Select></div>
                       <div className="col-span-1"><Input placeholder="Zip" value={primaryAddr.zip || ""} onChange={e=>updateAddr(primaryAddr.id,{zip:e.target.value})} /></div>
                    </div>
                 </div>
            </div>

            <div className="rounded-xl border border-slate-200 bg-white p-5 shadow-sm">
                <h3 className="mb-4 text-sm font-bold uppercase text-indigo-600">Scheduling</h3>
                <div className="grid grid-cols-3 gap-4 mb-4">
                     <button onClick={() => update('scheduleType', 'Scope')} className={`flex flex-col items-center justify-center gap-2 p-2 rounded-lg border-2 transition-all ${data.scheduleType === 'Scope' ? 'border-indigo-600 bg-indigo-50 text-indigo-700 shadow-sm' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'}`}><span className="text-lg">üìã</span><span className="font-bold text-xs">Scope</span></button>
                     <button onClick={() => update('scheduleType', 'Pickup')} className={`flex flex-col items-center justify-center gap-2 p-2 rounded-lg border-2 transition-all ${data.scheduleType === 'Pickup' ? 'border-indigo-600 bg-indigo-50 text-indigo-700 shadow-sm' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'}`}><span className="text-lg">üöö</span><span className="font-bold text-xs">Pickup</span></button>
                     <button onClick={() => update('scheduleType', 'In-Home')} className={`flex flex-col items-center justify-center gap-2 p-2 rounded-lg border-2 transition-all ${data.scheduleType === 'In-Home' ? 'border-indigo-600 bg-indigo-50 text-indigo-700 shadow-sm' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'}`}><span className="text-lg">üè°</span><span className="font-bold text-xs">In-Home</span></button>
                </div>
                <div className="grid gap-4 sm:grid-cols-2 mb-4">
                    <Field label="Date"><Input type="date" value={data.pickupDate} onChange={e=>update("pickupDate",e.target.value)} disabled={data.isLead} /></Field>
                    <Field label="Time"><Select value={data.pickupTime} onChange={e=>update("pickupTime",e.target.value)} disabled={data.isLead}>{TIME_SLOTS.map(t=><option key={t} value={t}>{t}</option>)}</Select></Field>
                </div>
                <div className="grid sm:grid-cols-2 gap-4 mb-4">
                    <button onClick={handleConfirmClick} disabled={data.isLead} className={`rounded-lg border px-4 py-3 text-sm font-semibold ${data.isLead ? 'border-slate-200 bg-slate-50 text-slate-400 cursor-not-allowed' : 'border-emerald-200 bg-emerald-50 text-emerald-700'}`}>‚úÖ Confirm Appointment</button>
                    <button onClick={() => setToast("Reminder Sent") } disabled={data.isLead} className={`rounded-lg border px-4 py-3 text-sm font-semibold ${data.isLead ? 'border-slate-200 bg-slate-50 text-slate-400 cursor-not-allowed' : 'border-indigo-200 bg-indigo-50 text-indigo-700'}`}>‚úâÔ∏è Send Reminder</button>
                </div>
                <Field label="Quick Notes" subtle>
                    <div className="flex flex-wrap gap-2">
                        {quickNotes.map(n => (
                            <ToggleMulti key={n} label={n} checked={(data.quickInstructionNotes||[]).includes(n)} onChange={()=>appendQuickNote(n)} />
                        ))}
                    </div>
                </Field>
                <Field label="Instructions / Notes"><Textarea value={data.eventInstructions} onChange={e => update("eventInstructions", e.target.value)} placeholder="Gate codes, parking instructions..." /></Field>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <QuickScopeFields data={data} update={update} toggleMulti={toggleMulti} />
                <LoadListFields data={data} update={update} toggleMulti={toggleMulti} />
            </div>

        </div>
    );
};

// --- MAIN APP ---

export default function App(){
  const SECTION_ORDER = ["sec1","sec2","sec3","sec4","sec5"];
  const [entryMode, setEntryMode] = useState("start"); 
  const [showInlineHelp, setShowInlineHelp] = useState(true);
  const [compactMode, setCompactMode] = useState(false);
  const [data, setData] = useState(() => {
    try {
      const s = localStorage.getItem("same-day-scope-v52");
      const parsed = s ? JSON.parse(s) : {};
      return { 
        ...DEFAULT_FORM, 
        ...parsed, 
        addresses: parsed.addresses?.length ? parsed.addresses : DEFAULT_FORM.addresses, 
        customers: parsed.customers?.length ? parsed.customers : DEFAULT_FORM.customers 
      };
    } catch(e) { return DEFAULT_FORM; }
  });
  const [toast, setToast] = useState("");
  const [showSearch, setShowSearch] = useState(false);
  const [openSections, setOpenSections] = useState({sec1:true, sec2:false, sec3:false, sec4:false, sec5:false}); 
  const [modal, setModal] = useState({type:"",value:"",onSave:null});
  const [openCodes, setOpenCodes] = useState(false);
  
  const [visitedSections, setVisitedSections] = useState(new Set(['sec1']));

  const [alertModal, setAlertModal] = useState({ isOpen: false, message: "", onConfirm: null });
  const [smartNotification, setSmartNotification] = useState(null);
  const [confirmDetails, setConfirmDetails] = useState(null);
  const [auditOpen, setAuditOpen] = useState(false);
  const [auditOn, setAuditOn] = useState(false);
  const [auditMissing, setAuditMissing] = useState([]);
  const [autoScrollDone, setAutoScrollDone] = useState(false);
  const [orderSubOpen, setOrderSubOpen] = useState(true);
  const [sourceSubOpen, setSourceSubOpen] = useState(true);
  const [interviewSubOpen, setInterviewSubOpen] = useState(false);
  const [codesSubOpen, setCodesSubOpen] = useState(false);
  
  const [minimizedLossTypes, setMinimizedLossTypes] = useState({});

  const [companies,setCompanies]=useState(()=>{ try { const s=localStorage.getItem("companies-registry"); return s?JSON.parse(s):DEFAULT_COMPANIES; } catch(e){ return DEFAULT_COMPANIES; }});
  const [contacts,setContacts]=useState(()=>{ try { const s=localStorage.getItem("contacts-registry"); return s?JSON.parse(s):DEFAULT_CONTACTS; } catch(e){ return DEFAULT_CONTACTS; }});

  useEffect(()=>{ localStorage.setItem("companies-registry",JSON.stringify(companies)); },[companies]);
  useEffect(()=>{ localStorage.setItem("contacts-registry",JSON.stringify(contacts)); },[contacts]);
  useEffect(()=>{ localStorage.setItem("same-day-scope-v52", JSON.stringify(data)); },[data]);

  useEffect(() => {
    const handleKeyDown = (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        setShowSearch(prev => !prev);
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  const update = useCallback((k,v) => setData(p=>({...p,[k]:v})), []);
  const updateAddr = useCallback((id,patch) => setData(p => ({...p, addresses: p.addresses.map(a=>a.id===id?{...a,...patch}:a)})), []);
  const updateCust = useCallback((id,patch) => setData(p => ({...p, customers: p.customers.map(c=>c.id===id?{...c,...patch}:c)})), []);

  const toggleMulti=(list,value)=> list.includes(value)? list.filter(v=>v!==value): [...list,value];
  const toggleHandling=(code)=> update("handlingCodes", toggleMulti(data.handlingCodes, code));
  
  const handleToggleSection = (key) => {
    setOpenSections(prev => {
        const isOpen = !prev[key];
        if(isOpen) {
            setVisitedSections(prevV => new Set([...prevV, key]));
            setTimeout(() => document.getElementById(key)?.scrollIntoView({behavior:'smooth', block:'start'}), 100);
        }
        return {...prev, [key]: isOpen};
    });
  };

  const jumpToSection = (key) => {
      setOpenSections(prev => ({...prev, [key]: true})); 
      setVisitedSections(prevV => new Set([...prevV, key]));
      setTimeout(() => {
          const el = document.getElementById(key);
          if(el) {
              el.scrollIntoView({behavior:'smooth', block:'start'});
              el.classList.remove('animate-purple-section-fade'); 
              void el.offsetWidth;
              el.classList.add('animate-purple-section-fade');
          }
      }, 100);
  };

  const goToNextSection = (currentKey) => {
    const idx = SECTION_ORDER.indexOf(currentKey);
    if (idx < 0 || idx === SECTION_ORDER.length - 1) return;
    const nextKey = SECTION_ORDER[idx + 1];
    setOpenSections(prev => ({ ...prev, [currentKey]: false, [nextKey]: true }));
    setVisitedSections(prevV => new Set([...prevV, nextKey]));
    setTimeout(() => {
      const el = document.getElementById(nextKey);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        el.classList.remove('animate-purple-section-fade');
        void el.offsetWidth;
        el.classList.add('animate-purple-section-fade');
      }
    }, 100);
  };

  const toggleLossType = (type) => {
     setData(prev => {
         const current = prev.orderTypes || [];
         const isActive = current.includes(type);
         let newTypes;
         if (isActive) {
             newTypes = current.filter(t => t !== type);
         } else {
             newTypes = [...current, type];
         }
         return { ...prev, orderTypes: newTypes };
     });
     if(!data.orderTypes.includes(type)) {
         setMinimizedLossTypes(p => ({...p, [type]: false}));
     }
  };
  
  const toggleSeverity = (code) => {
    setData(prev => {
        const current = prev.severityCodes || [];
        const type = code.split('-')[0]; 
        const others = current.filter(c => !c.startsWith(type + '-'));
        const isActive = current.includes(code);
        return { ...prev, severityCodes: isActive ? others : [...others, code] };
    });
  };

  const updateLossDetail = (type, field, value) => {
      setData(prev => {
          const details = prev.lossDetails || {};
          const typeDetails = details[type] || { causes: [], origins: [] };
          let newValue;
          if (Array.isArray(typeDetails[field])) {
              newValue = typeDetails[field].includes(value) ? typeDetails[field].filter(v => v !== value) : [...typeDetails[field], value];
          } else { newValue = value; }
          const nextTypeDetails = { ...typeDetails, [field]: newValue };
          return { ...prev, lossDetails: { ...details, [type]: nextTypeDetails } };
      });
  };

  const getLossSummary = (type) => {
      const d = (data.lossDetails || {})[type];
      if (!d) return "No details selected";
      const parts = [];
      if (d.causes && d.causes.length) parts.push(d.causes.join(", "));
      if (d.origins && d.origins.length) parts.push(d.origins.join(", "));
      return parts.join("; ");
  };

  const toggleMinimizeLoss = (type) => {
      setMinimizedLossTypes(prev => ({ ...prev, [type]: !prev[type] }));
  };

  const updateSmart = (k, v) => {
      let loadListAdded = [];
      let currentLoadList = new Set(data.loadList || []);

      if (k === 'noHeat' && v === true && !currentLoadList.has('Heater')) loadListAdded.push('Heater');
      if ((k === 'noLights' && v === true) || (k === 'boardedUp' && v === true)) { if(!currentLoadList.has('Lights')) loadListAdded.push('Lights'); }
      if (k === 'damageWasWet' && v === true && !currentLoadList.has('Plastic Bags')) loadListAdded.push('Plastic Bags');
      if (k === 'damageMoldMildew' && v === true && !currentLoadList.has('Tyvek')) loadListAdded.push('Tyvek');

      if (loadListAdded.length > 0) {
          setSmartNotification({ message: `Smart Update: Added ${loadListAdded.join(', ')}`, loadListToRemove: loadListAdded });
      }
      
      setData(prev => {
          let newData = { ...prev, [k]: v };
          let newLoadList = new Set(prev.loadList || []);
          loadListAdded.forEach(i => newLoadList.add(i));
          newData.loadList = Array.from(newLoadList);
          return newData;
      });
  };

  const rejectSmartAction = () => {
      if (smartNotification) {
          setData(prev => ({
              ...prev, 
              loadList: prev.loadList.filter(c => !(smartNotification.loadListToRemove || []).includes(c))
          }));
          setSmartNotification(null);
      }
  };
  
  const handleSearchHit = (type) => {
      if(LOSS_TYPES.includes(type)) {
          if(!data.orderTypes.includes(type)) {
              toggleLossType(type);
          }
          setMinimizedLossTypes(p => ({...p, [type]: false}));
      }
      if(type === 'Order Codes' || ['handling', 'severity', 'quality'].some(k => type.toLowerCase().includes(k))) {
          setOpenCodes(true);
      }
  };

  const handleConfirmClick = () => {
      setConfirmDetails({
          type: data.scheduleType,
          date: data.pickupDate,
          time: data.pickupTime,
          tech: data.assignedTech,
      });
  };
  
  const addNewAddress = useCallback(() => {
    setData(p => {
        const hasPrimary = p.addresses.some(a => a.isPrimary);
        return { ...p, addresses: [...p.addresses, initAddress({ isPrimary: !hasPrimary, isLossSite: false, type: "" })] };
    });
  }, []);
  
  const addNewCustomer = useCallback(() => {
    setData(p => ({ ...p, customers: [...p.customers, initCustomer({ type: "", policyHolder: false, isPrimary: false })] }));
  }, []);

  const verifyAddressDemo = useCallback((id) => {
    const demoLat = "40.8874";
    const demoLng = "-74.0291";
    updateAddr(id, { lat: demoLat, lng: demoLng });
    setToast("Address verified (demo).");
  }, [updateAddr]);
  
  const removeCust = useCallback((id, index) => { 
    if(index===0) setAlertModal({ isOpen: true, message: "Cannot delete primary customer.", onConfirm: null });
    else setAlertModal({ isOpen: true, message: "Remove this customer?", onConfirm: () => setData(p=>({...p,customers:p.customers.filter(x=>x.id!==id)})) });
  }, []);
  const removeAddr = useCallback((id) => setAlertModal({ isOpen: true, message: "Remove this address?", onConfirm: () => setData(p=>({...p,addresses:p.addresses.filter(a=>a.id!==id)})) }), []);

  const validateGenerateScope = () => {
    const missing = {};
    if(!(data.orderTypes||[]).length) missing.orderTypes=true;
    setData(p=>({...p,highlightMissing:missing}));
    if(Object.keys(missing).length){
      setOpenSections(p => ({...p, sec1:true}));
      setToast("Please complete required fields.");
      return false;
    }
    setToast("Order Complete! Submitting...");
    return true;
  };

  const computeAuditMissing = () => {
    const missing = [];
    const primaryCustomer = (data.customers || [])[0] || {};
    const primaryAddress = (data.addresses || [])[0] || {};

    if(!(data.orderTypes||[]).length) missing.push({ id: "sec1", label: "Order Type", section: "sec1", key: "orderTypes" });
    if(!data.referrer) missing.push({ id: "sec1", label: "Referrer", section: "sec1", key: "referrer" });
    if(!data.billingPayer) missing.push({ id: "sec4", label: "Bill To (Payer)", section: "sec4", key: "billingPayer" });

    if(!primaryCustomer.first) missing.push({ id: "sec2", label: "Customer First Name", section: "sec2", key: "custFirst" });
    if(!primaryCustomer.last) missing.push({ id: "sec2", label: "Customer Last Name", section: "sec2", key: "custLast" });
    if(!primaryCustomer.phone) missing.push({ id: "sec2", label: "Customer Phone", section: "sec2", key: "custPhone" });
    if(!primaryCustomer.email) missing.push({ id: "sec2", label: "Customer Email", section: "sec2", key: "custEmail" });

    if(!primaryAddress.street) missing.push({ id: "sec3", label: "Street Address", section: "sec3", key: "addrStreet" });
    if(!primaryAddress.city) missing.push({ id: "sec3", label: "City", section: "sec3", key: "addrCity" });
    if(!primaryAddress.state) missing.push({ id: "sec3", label: "State", section: "sec3", key: "addrState" });
    if(!primaryAddress.zip) missing.push({ id: "sec3", label: "Zip", section: "sec3", key: "addrZip" });
    if(!primaryAddress.lng) missing.push({ id: "sec3", label: "Longitude", section: "sec3", key: "addrLng" });
    if(!primaryAddress.lat) missing.push({ id: "sec3", label: "Latitude", section: "sec3", key: "addrLat" });

    return missing;
  };

  const runAudit = () => {
    const missing = computeAuditMissing();
    setAuditMissing(missing);
    const highlight = missing.reduce((acc, item) => { acc[item.key] = true; return acc; }, {});
    setData(p => ({ ...p, highlightMissing: { ...(p.highlightMissing||{}), ...highlight } }));
    setAuditOpen(true);
  };

  useEffect(() => {
    if (!auditOpen && !auditOn) return;
    const missing = computeAuditMissing();
    setAuditMissing(missing);
  }, [auditOpen, auditOn, data]);

  const codeSummary = [...(data.severityCodes||[]), data.qualityCode||"", ...(data.handlingCodes||[])].filter(Boolean).join(" ‚Ä¢ ") || "None";
  const knownPeople = useMemo(()=>{
    const s=new Set();
    (data.customers||[]).forEach(c=>{ if(c.first||c.last) s.add((c.first+' '+c.last).trim()); });
    [data.insuranceAdjuster,data.publicAdjuster,data.independentAdjuster,data.tpaContact].forEach(n=>{ if(n) s.add(n);});
    if(data.referrer) s.add(data.referrer); 
    Object.values(data.vendorDetails||{}).forEach(v=>{ if(v&&v.contact) s.add(v.contact)}); 
    (data.peopleQuick||[]).forEach(m=>{ if(m.first) s.add(m.first); });
    return Array.from(s).filter(Boolean);
  },[data]);

  const contactCompanyMap = useMemo(() => {
    const map = new Map();
    Object.values(data.additionalCompanies || {}).forEach(entry => {
      if (entry?.contact && entry?.company) {
        map.set(normalizeContact(entry.contact), entry.company);
      }
    });
    if (data.billingContact && data.billingCompany) {
      map.set(normalizeContact(data.billingContact), data.billingCompany);
    }
    return map;
  }, [data.additionalCompanies, data.billingContact, data.billingCompany]);

  const updateAdditionalCompanyType = (type) => {
    const next = toggleMulti(data.additionalCompanyTypes || [], type);
    setData(prev => {
      const updated = { ...prev, additionalCompanyTypes: next };
      const entries = { ...(prev.additionalCompanies || {}) };
      if (!entries[type]) entries[type] = { contact: "", company: "" };
      updated.additionalCompanies = entries;
      return updated;
    });
  };

  const updateAdditionalCompanyEntry = (type, patch) => {
    setData(prev => ({
      ...prev,
      additionalCompanies: {
        ...(prev.additionalCompanies || {}),
        [type]: { ...(prev.additionalCompanies?.[type] || { contact: "", company: "" }), ...patch }
      }
    }));
  };

  const handleAdditionalContactChange = (type, contact) => {
    const suggested = contactCompanyMap.get(normalizeContact(contact));
    setData(prev => ({
      ...prev,
      additionalCompanies: {
        ...(prev.additionalCompanies || {}),
        [type]: {
          ...(prev.additionalCompanies?.[type] || { contact: "", company: "" }),
          contact,
          company: (prev.additionalCompanies?.[type]?.company || suggested || "")
        }
      }
    }));
  };

  const handleBillingContactChange = (contact) => {
    const suggested = contactCompanyMap.get(normalizeContact(contact));
    setData(prev => ({
      ...prev,
      billingContact: contact,
      billingCompany: prev.billingCompany || suggested || ""
    }));
  };

  useEffect(() => {
    let didCollapse = false;
    (data.orderTypes || []).forEach(type => {
      const d = (data.lossDetails || {})[type];
      const hasCauses = d?.causes?.length > 0;
      const hasOrigins = d?.origins?.length > 0;
      if (hasCauses && hasOrigins && !minimizedLossTypes[type]) {
        didCollapse = true;
        setMinimizedLossTypes(p => ({ ...p, [type]: true }));
      }
    });
    if (didCollapse && !autoScrollDone) {
      setAutoScrollDone(true);
      setTimeout(() => {
        const el = document.getElementById("sec1-interview");
        if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 300);
    }
  }, [data.lossDetails, data.orderTypes, minimizedLossTypes, autoScrollDone]);

  const activeSectionId = useMemo(() => {
      if(openSections.sec5) return 'sec5'; if(openSections.sec4) return 'sec4'; if(openSections.sec3) return 'sec3'; if(openSections.sec2) return 'sec2'; return 'sec1'; 
  }, [openSections]);

  if (entryMode === 'start') return <StartScreen onSelect={setEntryMode} />;

  return (
    <React.Fragment>
        <style>{STYLES}</style>
        
        <GlobalSearch show={showSearch} onClose={()=>setShowSearch(false)} onNavigate={jumpToSection} onSearchHit={handleSearchHit} />

        <Header 
            activeSection={activeSectionId} 
            visitedSections={visitedSections} 
            onJump={jumpToSection} 
            title={entryMode === 'quick' ? 'Quick Entry' : 'New Order'} 
            version="v55"
            entryMode={entryMode}
            setEntryMode={setEntryMode}
            showInlineHelp={showInlineHelp}
            setShowInlineHelp={setShowInlineHelp}
            compactMode={compactMode}
            setCompactMode={setCompactMode}
        />

        <div className={`min-h-screen bg-slate-50 pb-32 font-sans fade-in scale-in ${compactMode ? 'compact-mode' : ''} ${entryMode === 'detailed' ? 'pt-28' : 'pt-24'}`}>
            
            <div className="absolute inset-x-0 top-0 h-[320px] bg-gradient-to-b from-indigo-50/50 to-transparent pointer-events-none" />

            <div className="mx-auto max-w-6xl px-2 sm:px-4 relative"> 
              
              {entryMode === 'detailed' ? (
                <>
                  <div className={compactMode ? "space-y-3" : "space-y-4"}>
                    
                    REPLACEME

                    <Section id="sec2" title="2. Customer" isOpen={openSections.sec2} onToggle={()=>handleToggleSection('sec2')} compact={compactMode}>
                      <div className="space-y-4">
                        {data.customers.map((c,i)=><CustomerItem key={c.id} c={c} index={i} total={data.customers.length} updateCust={updateCust} onRemove={removeCust} highlightMissing={data.highlightMissing} />)}
                        <div className="pt-2"><button onClick={addNewCustomer} className="w-full rounded-lg border-2 border-dashed border-slate-300 p-3 text-sm font-bold text-slate-500 hover:border-indigo-500 hover:text-indigo-600 transition-colors">+ Add Another Customer</button></div>
                        <div className="flex items-center justify-end gap-2 pt-2 border-t border-slate-100">
                          <button onClick={() => handleToggleSection('sec2')} className="rounded-lg px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700">Done</button>
                          <button onClick={() => goToNextSection('sec2')} className="rounded-lg bg-indigo-600 px-5 py-2 text-sm font-bold text-white hover:bg-indigo-700">Next</button>
                        </div>
                      </div>
                    </Section>

                    <Section id="sec3" title="3. Address" isOpen={openSections.sec3} onToggle={()=>handleToggleSection('sec3')} compact={compactMode}>
                      <div className="space-y-4">
                        {data.addresses.map((a,i)=><AddressItem key={a.id} addr={a} total={data.addresses.length} updateAddr={updateAddr} onRemove={removeAddr} index={i} highlightMissing={data.highlightMissing} onVerify={verifyAddressDemo} ToggleMulti={ToggleMulti} />)}
                        <div className="pt-2"><button onClick={addNewAddress} className="w-full rounded-lg border-2 border-dashed border-slate-300 p-3 text-sm font-bold text-slate-500 hover:border-indigo-500 hover:text-indigo-600 transition-colors">+ Add Another Address</button></div>
                        <div className="flex items-center justify-end gap-2 pt-2 border-t border-slate-100">
                          <button onClick={() => handleToggleSection('sec3')} className="rounded-lg px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700">Done</button>
                          <button onClick={() => goToNextSection('sec3')} className="rounded-lg bg-indigo-600 px-5 py-2 text-sm font-bold text-white hover:bg-indigo-700">Next</button>
                        </div>
                      </div>
                    </Section>

                    <Section id="sec4" title="4. Billing" isOpen={openSections.sec4} onToggle={()=>handleToggleSection('sec4')} compact={compactMode}>
                      <div className="grid gap-6">
                        <Field label="Payer"><div className={data.highlightMissing?.billingPayer ? "audit-missing rounded-lg p-1" : ""}><ToggleGroup options={["Insurance","Customer","Referrer","Building","Contractor","Other"]} value={data.billingPayer} onChange={v=>update("billingPayer",v)} /></div></Field>
                        <Field label="Direction of Payment"><ToggleGroup options={["Direct from Insurance","Check","Credit Card","Other"]} value={data.directionOfPayment} onChange={v=>update("directionOfPayment",v)} /></Field>
                        <div className="grid sm:grid-cols-2 gap-4">
                          <Field label="Billing Company"><Input value={data.billingCompany} onChange={e=>update("billingCompany", e.target.value)} placeholder="Billing company" /></Field>
                          <Field label="Billing Contact" subtle action={<span className="text-[10px] text-slate-400">Auto-fill company</span>}>
                            <Input value={data.billingContact} onChange={e=>handleBillingContactChange(e.target.value)} placeholder="Billing contact" />
                          </Field>
                        </div>
                        <Field label="Billing Note"><Textarea value={data.billingNote} onChange={e=>update("billingNote",e.target.value)} /></Field>
                        <Field label="Insurance Claim?" smart action={<ToggleGroup options={["Yes","No"]} value={data.insuranceClaim} onChange={v=>update("insuranceClaim",v)} />} />
                        {data.insuranceClaim==="Yes" && (
                          <div className="animate-purple-section-fade slide-up rounded-xl bg-white p-4 grid gap-4 shadow-sm">
                            <Field label="Insurance Carrier">
                              <div className="flex gap-2">
                                <SearchSelect value={data.insuranceCompany} onChange={(v)=>update("insuranceCompany",v)} options={companies} listId="insurance-company-list" />
                                <button className="rounded-lg bg-white px-3 font-bold text-indigo-600 shadow-sm hover:bg-indigo-50" onClick={()=>setModal({type:"company",value:"",onSave:(name)=>update("insuranceCompany",name)})}>+</button>
                              </div>
                            </Field>
                            <Field label="Adjuster">
                              <div className="flex gap-2">
                                <SearchSelect value={data.insuranceAdjuster} onChange={(v)=>update("insuranceAdjuster",v)} options={contacts} listId="insurance-adjuster-list" />
                                <button className="rounded-lg bg-white px-3 font-bold text-indigo-600 shadow-sm hover:bg-indigo-50" onClick={()=>setModal({type:"contact",value:"",onSave:(name)=>update("insuranceAdjuster",name)})}>+</button>
                              </div>
                            </Field>
                            <div className="grid grid-cols-2 gap-4"><Field label="Claim #"><Input value={data.claimNumber} onChange={e=>update("claimNumber",e.target.value)} /></Field><Field label="Date of Loss"><Input value={data.dateOfLoss} onChange={e=>update("dateOfLoss",e.target.value)} placeholder="mm/dd/yyyy" /></Field></div>
                          </div>
                        )}

                        <Field label="Rent or Own?">
                          <div className="flex gap-2">
                            <ToggleMulti label="Rent" checked={data.rentOrOwn === "Rent"} onChange={() => update("rentOrOwn", data.rentOrOwn === "Rent" ? "" : "Rent")} />
                            <ToggleMulti label="Own" checked={data.rentOrOwn === "Own"} onChange={() => update("rentOrOwn", data.rentOrOwn === "Own" ? "" : "Own")} />
                          </div>
                        </Field>
                        {data.rentOrOwn === "Rent" && (
                          <div className="rounded-xl border border-amber-300 bg-amber-50 p-4">
                            <div className="text-sm font-semibold text-amber-700 mb-2">Tenant coverage warning: verify contents coverage before proceeding.</div>
                            <div className="grid sm:grid-cols-2 gap-4">
                              <Field label="Contents Limit ($)"><Input value={data.contentsCoverageLimit} onChange={e=>update("contentsCoverageLimit",e.target.value)} /></Field>
                              <Field label="Mold Limit ($)"><Input value={data.moldLimit} onChange={e=>update("moldLimit",e.target.value)} /></Field>
                            </div>
                          </div>
                        )}

                        <div className="rounded-2xl border border-slate-200">
                          <button className="w-full flex items-center justify-between px-5 py-4 text-sm font-semibold text-slate-800">
                            Referrals & Vendor Info
                            <span className="text-slate-400">‚ñæ</span>
                          </button>
                          <div className="border-t border-slate-200 p-5 space-y-4">
                            <div className="grid md:grid-cols-[1fr_auto] gap-3 items-end">
                              <div>
                                <Field label="Referring Company" />
                                <SearchSelect value={data.referringCompany} onChange={(v)=>update("referringCompany", v)} options={companies} listId="referring-company-list-2" />
                              </div>
                              <button className="rounded-xl border border-indigo-200 px-3 py-2 text-indigo-600" onClick={()=>setModal({type:"company",value:"",onSave:(name)=>update("referringCompany",name)})}>+</button>
                            </div>
                            <div>
                              <Field label="Vendors Involved" />
                              <div className="flex flex-wrap gap-2">
                                {VENDOR_TYPES.map(v => (
                                  <ToggleMulti key={v} label={v} checked={(data.vendors||[]).includes(v)} onChange={() => update("vendors", toggleMulti(data.vendors||[], v))} />
                                ))}
                              </div>
                            </div>
                          </div>
                        </div>

                        <div className="rounded-2xl border border-slate-200 p-5 space-y-5">
                          <div>
                            <Field label="Additional Companies" subtle action={<span className="text-[10px] text-slate-400">Select types to add contact + company</span>} />
                            <div className="flex flex-wrap gap-2">
                              {COMPANY_TYPES.map(t => (
                                <ToggleMulti key={t} label={t} checked={(data.additionalCompanyTypes||[]).includes(t)} onChange={() => updateAdditionalCompanyType(t)} />
                              ))}
                            </div>
                          </div>
                          <div className="grid md:grid-cols-2 gap-4">
                            {(data.additionalCompanyTypes||[]).map((type) => {
                              const entry = (data.additionalCompanies||{})[type] || { contact: "", company: "" };
                              return (
                                <div key={type} className="rounded-2xl border border-slate-200 bg-white p-4">
                                  <div className="text-xs font-semibold uppercase tracking-wider text-slate-400">{type}</div>
                                  <div className="mt-3">
                                    <Field label="Contact" subtle action={<span className="text-[10px] text-slate-400">Type a known contact to auto-fill company</span>}>
                                      <Input value={entry.contact} onChange={e=>handleAdditionalContactChange(type, e.target.value)} placeholder="Contact name" />
                                    </Field>
                                  </div>
                                  <div className="mt-4">
                                    <Field label="Company"><Input value={entry.company} onChange={e=>updateAdditionalCompanyEntry(type, { company: e.target.value })} placeholder="Company name" /></Field>
                                  </div>
                                </div>
                              )
                            })}
                          </div>
                        </div>
                        <div className="flex items-center justify-end gap-2 pt-2 border-t border-slate-100">
                          <button onClick={() => handleToggleSection('sec4')} className="rounded-lg px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700">Done</button>
                          <button onClick={() => goToNextSection('sec4')} className="rounded-lg bg-indigo-600 px-5 py-2 text-sm font-bold text-white hover:bg-indigo-700">Next</button>
                        </div>
                      </div>
                    </Section>

                    <Section id="sec5" title="5. Schedule" isOpen={openSections.sec5} onToggle={()=>handleToggleSection('sec5')} compact={compactMode}>
                      <div className="space-y-6">
                        <div className="grid grid-cols-3 gap-4">
                          <button onClick={() => update('scheduleType', 'Scope')} className={`flex flex-col items-center justify-center gap-2 p-2 rounded-lg border-2 transition-all ${data.scheduleType === 'Scope' ? 'border-indigo-600 bg-indigo-50 text-indigo-700 shadow-sm' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'}`}><span className="text-lg">üìã</span><span className="font-bold text-xs">Scope Only</span></button>
                          <button onClick={() => update('scheduleType', 'Pickup')} className={`flex flex-col items-center justify-center gap-2 p-2 rounded-lg border-2 transition-all ${data.scheduleType === 'Pickup' ? 'border-indigo-600 bg-indigo-50 text-indigo-700 shadow-sm' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'}`}><span className="text-lg">üöö</span><span className="font-bold text-xs">Pickup</span></button>
                          <button onClick={() => update('scheduleType', 'In-Home')} className={`flex flex-col items-center justify-center gap-2 p-2 rounded-lg border-2 transition-all ${data.scheduleType === 'In-Home' ? 'border-indigo-600 bg-indigo-50 text-indigo-700 shadow-sm' : 'border-slate-200 bg-white text-slate-600 hover:border-slate-300'}`}><span className="text-lg">üè°</span><span className="font-bold text-xs">In-Home</span></button>
                        </div>
                        <div className="grid gap-4 sm:grid-cols-2"><Field label="Date"><Input type="date" value={data.pickupDate} onChange={e=>update("pickupDate",e.target.value)} /></Field><Field label="Time"><Select value={data.pickupTime} onChange={e=>update("pickupTime",e.target.value)}>{TIME_SLOTS.map(t=><option key={t} value={t}>{t}</option>)}</Select></Field></div>
                        <div className="grid sm:grid-cols-2 gap-4">
                          <button onClick={handleConfirmClick} className="rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm font-semibold text-emerald-700">‚úÖ Confirm Appointment</button>
                          <button onClick={() => setToast("Reminder Sent") } className="rounded-lg border border-indigo-200 bg-indigo-50 px-4 py-3 text-sm font-semibold text-indigo-700">‚úâÔ∏è Send Reminder</button>
                        </div>
                        <Field label="Order Lead"><SearchSelect value={data.assignedTech} onChange={(v)=>update("assignedTech",v)} options={TECHS} listId="tech-list" placeholder="Select tech..." /></Field>
                        <Field label="Event Instructions"><Textarea value={data.eventInstructions} onChange={e => update("eventInstructions", e.target.value)} placeholder="Gate codes, parking instructions, special notes..." /></Field>
                        <Field label="Estimate Requested?" action={<Switch checked={data.estimateRequested} onChange={(val)=>update("estimateRequested", val)} />} />
                        {data.estimateRequested && (
                          <Field label="Type"><div className="flex flex-wrap gap-2">{ESTIMATE_TYPES.map(t => (<ToggleMulti key={t} label={t} checked={data.estimateType === t} onChange={()=>update("estimateType", t)} />))}</div></Field>
                        )}
                        <Field label="Who are we meeting?"><div className="flex flex-wrap gap-2">{(knownPeople.length > 0) ? knownPeople.map(p => (<ToggleMulti key={p} label={p} checked={(data.meetingWith || []).includes(p)} onChange={() => update("meetingWith", toggleMulti(data.meetingWith || [], p))}/>)) : <span className="text-sm text-slate-400 italic">Add customers or contacts first</span>}</div></Field>
                        <div className="flex items-center justify-end gap-2 pt-2 border-t border-slate-100">
                          <button onClick={() => handleToggleSection('sec5')} className="rounded-lg px-4 py-2 text-sm font-semibold text-slate-500 hover:text-slate-700">Done</button>
                        </div>
                      </div>
                    </Section>
                    
                  </div>
                </>
              ) : (
                <QuickEntry 
                    data={data} 
                    update={update} 
                    updateAddr={updateAddr}
                    updateCust={updateCust}
                    companies={companies} 
                    setModal={setModal} 
                    toggleMulti={toggleMulti} 
                    updateSmart={updateSmart}
                    handleConfirmClick={handleConfirmClick}
                    setToast={setToast}
                    showInlineHelp={showInlineHelp}
                />
              )}

            </div>
        </div>

        <FloatingCapsule 
            entryMode={entryMode} 
            setEntryMode={setEntryMode} 
            onSave={validateGenerateScope} 
            onAudit={() => {
              setAuditOn(prev => {
                const next = !prev;
                setAuditOpen(next);
                return next;
              });
            }}
            auditOn={auditOn}
            setShowSearch={setShowSearch}
        />

        {(auditOpen || auditOn) && (
          <div className="fixed right-4 top-28 z-[80] w-[320px] rounded-2xl border border-slate-200 bg-white shadow-2xl">
            <div className="flex items-center justify-between px-4 py-3 border-b border-slate-200">
              <div className="text-sm font-bold text-slate-800">Audit</div>
              <div className="flex items-center gap-2">
                <span className={`text-[10px] font-bold px-2 py-1 rounded-full border ${auditOn ? 'audit-pill' : 'border-slate-200 text-slate-400'}`}>{auditOn ? 'ON' : 'OFF'}</span>
                <button className="text-slate-400 hover:text-slate-600" onClick={() => setAuditOpen(false)}>√ó</button>
              </div>
            </div>
            <div className="px-4 py-3 text-xs text-slate-500">Missing critical fields:</div>
            <div className="max-h-[320px] overflow-y-auto custom-scroll px-4 pb-4 space-y-2">
              {auditMissing.length === 0 ? (
                <div className="rounded-lg border border-emerald-200 bg-emerald-50 px-3 py-2 text-xs text-emerald-700">All critical fields complete.</div>
              ) : (
                auditMissing.map((item, idx) => (
                  <button
                    key={`${item.key}-${idx}`}
                    onClick={() => jumpToSection(item.section)}
                    className="w-full text-left rounded-lg px-3 py-2 border border-slate-200 hover:border-indigo-300 hover:bg-indigo-50"
                  >
                    <div className="text-xs font-bold text-slate-700">{item.label}</div>
                    <div className="text-[10px] text-slate-400">Go to section</div>
                  </button>
                ))
              )}
            </div>
          </div>
        )}
      
      {toast && <Toast message={toast} onClose={()=>setToast("")} />}
      {smartNotification && <SmartNotification message={smartNotification.message} onReject={rejectSmartAction} onClose={()=>setSmartNotification(null)} />}
      
      {modal.type && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4">
              <div className="w-full max-w-sm rounded-2xl bg-white p-6 shadow-2xl ring-1 ring-black/5 fade-in">
                  <h3 className="mb-4 text-lg font-bold text-slate-900 capitalize">Add New {modal.type}</h3>
                  <Input autoFocus placeholder={`Enter ${modal.type} name...`} value={modal.value} onChange={e=>setModal(m=>({...m,value:e.target.value}))} />
                  <div className="flex justify-end gap-3 mt-4">
                      <button className="rounded-lg px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-50" onClick={()=>setModal({type:"",value:"",onSave:null})}>Cancel</button>
                      <button className="rounded-lg bg-indigo-600 px-5 py-2 text-sm font-bold text-white hover:bg-indigo-700" onClick={()=>{ const v = modal.value.trim(); if(v) { if(modal.type === 'company') setCompanies(p => Array.from(new Set([...p, v]))); if(modal.type === 'contact') setContacts(p => Array.from(new Set([...p, v]))); modal.onSave(v); setModal({type:"",value:"",onSave:null}); } }}>Save</button>
                  </div>
              </div>
          </div>
      )}
      
      {confirmDetails && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
              <div className="w-full max-w-md rounded-2xl bg-white shadow-2xl ring-1 ring-black/5 overflow-hidden animate-purple-section-fade">
                  <div className="bg-indigo-600 px-6 py-4">
                      <h3 className="text-xl font-bold text-white flex items-center gap-2"><span>üìÖ</span> Confirm Appointment</h3>
                  </div>
                  <div className="p-6 space-y-4">
                          <div className="grid grid-cols-2 gap-4">
                              <div><label className="text-xs font-bold text-slate-400 uppercase">Type</label><div className="font-medium">{confirmDetails.type}</div></div>
                              <div><label className="text-xs font-bold text-slate-400 uppercase">Date & Time</label><div className="font-medium">{confirmDetails.date} @ {confirmDetails.time}</div></div>
                          </div>
                          <div><label className="text-xs font-bold text-slate-400 uppercase">Address</label><div className="font-medium">{confirmDetails.address || "No Primary Address Set"}</div></div>
                  </div>
                  <div className="bg-slate-50 px-6 py-4 flex justify-end gap-3 border-t border-slate-200">
                      <button className="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-700" onClick={() => setConfirmDetails(null)}>Edit</button>
                      <button className="rounded-lg bg-green-600 px-6 py-2 text-sm font-bold text-white shadow hover:bg-green-700" onClick={() => { setToast("Appointment Confirmed & Sent!"); setConfirmDetails(null); }}>Send Confirmation</button>
                  </div>
              </div>
          </div>
      )}
    </React.Fragment>
  );
}
